# Implementa√ß√£o de Nota√ß√£o Musical H√≠brida - Maestro MCP

## üéØ Objetivo

Implementar o **formato h√≠brido de nota√ß√£o musical** em todas as ferramentas MIDI do servidor Maestro MCP, substituindo o sistema atual por uma abordagem mais expressiva e musicalmente intuitiva, mantendo total compatibilidade com c√≥digo existente.

## üìã Especifica√ß√£o do Novo Formato

### Estrutura Base
```typescript
interface MusicInput {
  // OBRIGAT√ìRIOS
  bpm: number;                    // 60-200 BPM
  notes: string;                  // Nota√ß√£o h√≠brida: "A4:q@0.8.leg B4:e | C4:h"
  
  // OPCIONAIS - Estrutura Musical
  timeSignature?: string;         // "4/4", "3/4", "6/8", etc. (padr√£o: "4/4")
  key?: string;                   // "C major", "A minor", etc.
  
  // OPCIONAIS - Padr√µes Globais (fallback quando n√£o especificado inline)
  velocity?: number;              // 0.0-1.0 (padr√£o: 0.8)
  articulation?: number;          // 0.0-1.0 (0=staccato, 1=legato, padr√£o: 0.8)
  reverb?: number;                // 0.0-1.0 (padr√£o: 0.4)
  swing?: number;                 // 0.0-1.0 (0=straight, 0.67=swing, padr√£o: 0.0)
  
  // OPCIONAIS - T√©cnicos
  channel?: number;               // 1-16 (padr√£o: 1)
  transpose?: number;             // -12 a +12 semitons (padr√£o: 0)
}
```

## üéº Sintaxe da Nota√ß√£o H√≠brida

### Formato Completo
```
nota:dura√ß√£o@velocity.articula√ß√£o
```

### Componentes

#### **Notas**
- `C4`, `D#4`, `Bb3` - Nota + oitava (0-9)
- Sustenidos: `#` (C#4, F#3)
- Bem√≥is: `b` (Bb4, Eb3)

#### **Dura√ß√µes**
| C√≥digo | Nome | Beats (4/4) | Exemplo |
|--------|------|-------------|---------|
| `w` | Whole (Semibreve) | 4.0 | `C4:w` |
| `h` | Half (M√≠nima) | 2.0 | `C4:h` |
| `q` | Quarter (Sem√≠nima) | 1.0 | `C4:q` |
| `e` | Eighth (Colcheia) | 0.5 | `C4:e` |
| `s` | Sixteenth (Semicolcheia) | 0.25 | `C4:s` |
| `t` | Thirty-second (Fusa) | 0.125 | `C4:t` |

#### **Velocity Inline (Opcional)**
- `@0.8` - Velocity espec√≠fica (0.0-1.0)
- Se omitido, usa o valor global `velocity`

#### **Articula√ß√£o Inline (Opcional)**
| C√≥digo | Significado | Efeito |
|--------|-------------|--------|
| `.leg` | Legato | articulation: 1.0, notas conectadas |
| `.stac` | Staccato | articulation: 0.0, notas curtas |
| `.ten` | Tenuto | articulation: 0.9, notas sustentadas |
| `.accent` | Accent | velocity: +0.2, nota enfatizada |
| `.ghost` | Ghost note | velocity: -0.3, nota sutil |

#### **Separadores**
- `|` - Separador de compasso
- ` ` (espa√ßo) - Separador de notas

## üéµ Exemplos de Uso

### Exemplo 1: Simples (usa padr√µes globais)
```json
{
  "bpm": 120,
  "notes": "C4:q D4:q E4:q F4:q | G4:h A4:h"
}
```

### Exemplo 2: Expressivo (controle granular)
```json
{
  "bpm": 156,
  "timeSignature": "4/4",
  "key": "D major",
  "notes": "A4:q@0.7.leg B4:e@0.8 A4:e@0.9.stac | G4:h@0.85.leg F#4:h@0.8",
  "velocity": 0.75,
  "articulation": 0.8,
  "reverb": 0.6
}
```

### Exemplo 3: Jazz com Swing
```json
{
  "bpm": 120,
  "timeSignature": "4/4",
  "key": "Bb major",
  "notes": "C4:q@0.8.accent D4:e@0.6.ghost E4:e@0.9 F4:q@0.7.leg",
  "swing": 0.67,
  "reverb": 0.4
}
```

## ‚öôÔ∏è Implementa√ß√£o T√©cnica

### 1. Parser de Nota√ß√£o H√≠brida

**Localiza√ß√£o:** `src/utils/hybrid-notation-parser.ts`

```typescript
interface ParsedNote {
  note: string;           // "C4"
  duration: number;       // Em beats (1.0 = quarter note)
  velocity: number;       // 0.0-1.0 (combinando global + inline)
  articulation: number;   // 0.0-1.0 (combinando global + inline)
  measureIndex: number;   // Qual compasso (0-based)
  beatPosition: number;   // Posi√ß√£o no compasso
  absoluteTime: number;   // Tempo absoluto em segundos
}

function parseHybridNotation(
  notes: string,
  globalDefaults: {
    bpm: number;
    velocity: number;
    articulation: number;
    timeSignature: string;
  }
): ParsedNote[] {
  // Implementar parsing seguindo a sintaxe especificada
  
  // 1. Dividir por compassos (split "|")
  // 2. Para cada compasso, dividir por notas (split " ")
  // 3. Para cada nota, fazer parse de "nota:dura√ß√£o@velocity.articula√ß√£o"
  // 4. Aplicar fallbacks globais quando inline n√£o especificado
  // 5. Calcular timing absoluto baseado em BPM e timeSignature
  
  return parsedNotes;
}

function parseNoteString(noteStr: string, globalDefaults: any): ParsedNote {
  // "A4:q@0.8.leg" ‚Üí {note: "A4", duration: 1.0, velocity: 0.8, articulation: 1.0}
  // "B4:e" ‚Üí {note: "B4", duration: 0.5, velocity: globalDefaults.velocity, articulation: globalDefaults.articulation}
}

const DURATION_MAP = {
  'w': 4.0,   // whole
  'h': 2.0,   // half
  'q': 1.0,   // quarter
  'e': 0.5,   // eighth
  's': 0.25,  // sixteenth
  't': 0.125  // thirty-second
};

const ARTICULATION_MAP = {
  'leg': 1.0,     // legato
  'stac': 0.0,    // staccato
  'ten': 0.9,     // tenuto
  'accent': 'velocity+0.2',  // boost velocity
  'ghost': 'velocity-0.3'    // reduce velocity
};
```

### 2. Atualiza√ß√£o dos Schemas

**Localiza√ß√£o:** `src/schemas/midi-schemas.ts`

```typescript
export const HybridMusicInputSchema = z.object({
  // Obrigat√≥rios
  bpm: z.number().min(60).max(200),
  notes: z.string().min(1),
  
  // Opcionais - Estrutura
  timeSignature: z.string().regex(/^\d+\/\d+$/).optional().default("4/4"),
  key: z.string().optional(),
  
  // Opcionais - Padr√µes Globais
  velocity: z.number().min(0).max(1).optional().default(0.8),
  articulation: z.number().min(0).max(1).optional().default(0.8),
  reverb: z.number().min(0).max(1).optional().default(0.4),
  swing: z.number().min(0).max(1).optional().default(0.0),
  
  // Opcionais - T√©cnicos
  channel: z.number().min(1).max(16).optional().default(1),
  transpose: z.number().min(-12).max(12).optional().default(0)
});

export const LegacyMusicInputSchema = z.object({
  // Manter schema atual para compatibilidade
  notes: z.union([z.string(), z.array(z.string())]),
  rhythm: z.array(z.string()).optional(),
  tempo: z.number().optional(),
  channel: z.number().optional(),
  velocity: z.number().optional(),
  gap: z.number().optional(),
  style: z.string().optional()
});

export const UnifiedMusicInputSchema = z.union([
  HybridMusicInputSchema,
  LegacyMusicInputSchema
]);
```

### 3. Detec√ß√£o Autom√°tica de Formato

```typescript
function detectInputFormat(input: any): 'hybrid' | 'legacy' {
  // Se tem "notes" como string COM ":" = h√≠brido
  if (typeof input.notes === 'string' && input.notes.includes(':')) {
    return 'hybrid';
  }
  
  // Se tem "rhythm" array = legacy
  if (input.rhythm && Array.isArray(input.rhythm)) {
    return 'legacy';
  }
  
  // Se tem "notes" como array = legacy
  if (Array.isArray(input.notes)) {
    return 'legacy';
  }
  
  // Default para h√≠brido
  return 'hybrid';
}
```

## üõ†Ô∏è Ferramentas a Atualizar

### Lista Completa
1. `maestro:midi_play_phrase` ‚≠ê (principal)
2. `maestro:midi_send_note`
3. `maestro:midi_sequence_commands`
4. `maestro:midi_import_score`
5. Qualquer outra ferramenta que aceite par√¢metros musicais

### Estrutura de Atualiza√ß√£o por Ferramenta

#### Para cada ferramenta:
1. **Manter compatibilidade total** com formato atual
2. **Adicionar suporte** ao formato h√≠brido
3. **Detectar automaticamente** qual formato foi usado
4. **Retornar metadata** sobre processamento

#### Exemplo de atualiza√ß√£o:
```typescript
// Em src/tools/midi-tools.ts

export const midi_play_phrase = {
  name: "maestro:midi_play_phrase",
  description: `
  üéµ Toca uma frase musical com m√°xima expressividade.
  
  FORMATO H√çBRIDO (Recomendado):
  {
    "bpm": 120,
    "notes": "C4:q@0.8.leg D4:e E4:e.stac | F4:h@0.9",
    "reverb": 0.6
  }
  
  FORMATO LEGADO (Compat√≠vel):
  {
    "notes": "C4 D4 E4 F4",
    "rhythm": ["quarter", "eighth", "eighth", "half"],
    "tempo": 120
  }
  `,
  inputSchema: UnifiedMusicInputSchema,
  
  async handler(args) {
    const format = detectInputFormat(args);
    
    let parsedNotes: ParsedNote[];
    
    if (format === 'hybrid') {
      parsedNotes = parseHybridNotation(args.notes, {
        bpm: args.bpm,
        velocity: args.velocity || 0.8,
        articulation: args.articulation || 0.8,
        timeSignature: args.timeSignature || "4/4"
      });
    } else {
      // Converter formato legado para estrutura comum
      parsedNotes = convertLegacyToCommon(args);
    }
    
    // Aplicar efeitos (reverb, swing, etc.)
    const processedNotes = applyEffects(parsedNotes, {
      reverb: args.reverb || 0.4,
      swing: args.swing || 0.0,
      transpose: args.transpose || 0
    });
    
    // Executar via MIDI
    const result = await executeMIDI(processedNotes, args.channel || 1);
    
    return {
      success: true,
      message: `Playing phrase with ${format} notation`,
      noteCount: parsedNotes.length,
      format: format,
      duration: calculateTotalDuration(parsedNotes),
      // Metadata para debug
      parsedNotes: parsedNotes.length < 20 ? parsedNotes : undefined
    };
  }
};
```

## üìö Documenta√ß√£o

### Atualizar Documenta√ß√£o Existente

#### `docs/API.md`
- Adicionar se√ß√£o "Nota√ß√£o Musical H√≠brida"
- Exemplos detalhados por caso de uso
- Migra√ß√£o do formato legado
- Troubleshooting comum

#### `docs/MUSICAL_EXAMPLES.md`
- Oblivion da Grimes em formato h√≠brido
- Parab√©ns pra Voc√™ com expressividade
- Jazz standard com swing
- M√∫sica cl√°ssica com din√¢micas
- Rock/Pop com articula√ß√µes

#### `README.md`
- Atualizar exemplos principais
- Destacar novo formato como padr√£o
- Manter exemplos legado para compatibilidade

### Nova Documenta√ß√£o

#### `docs/HYBRID_NOTATION.md`
```markdown
# Nota√ß√£o Musical H√≠brida - Guia Completo

## Sintaxe B√°sica
`nota:dura√ß√£o@velocity.articula√ß√£o`

## Exemplos por G√™nero Musical
- **Pop/Rock**: Articula√ß√µes mistas, din√¢micas contrastantes
- **Jazz**: Swing, ghost notes, acentos
- **Cl√°ssico**: Din√¢micas graduais, articula√ß√µes precisas
- **Eletr√¥nico**: Timing preciso, efeitos de reverb

## Migra√ß√£o do Formato Legado
[Guia passo a passo para converter c√≥digo existente]

## Refer√™ncia Completa de Par√¢metros
[Tabela detalhada de todos os par√¢metros com exemplos]
```

## ‚úÖ Crit√©rios de Sucesso

### Funcionais
- [ ] Todas as ferramentas MIDI suportam formato h√≠brido
- [ ] 100% compatibilidade com formato legado mantida
- [ ] Detec√ß√£o autom√°tica de formato funciona corretamente
- [ ] Timing musical √© preciso (toler√¢ncia ¬±5ms)
- [ ] Articula√ß√µes s√£o aplicadas adequadamente

### Qualidade de C√≥digo
- [ ] Parser √© robusto (trata casos edge)
- [ ] Schemas validam entrada corretamente
- [ ] Logs s√£o claros e informativos
- [ ] Errors t√™m mensagens √∫teis
- [ ] Performance adequada (<10ms para 100 notas)

### Documenta√ß√£o
- [ ] Exemplos s√£o claros e funcionais
- [ ] Par√¢metros s√£o explicados adequadamente
- [ ] Migra√ß√£o √© documentada
- [ ] Troubleshooting cobre casos comuns

## üß™ Testes de Valida√ß√£o

### Casos de Teste Obrigat√≥rios

#### 1. Compatibilidade Legado
```json
// Deve funcionar exatamente como antes
{
  "notes": "C4 D4 E4 F4",
  "rhythm": ["quarter", "quarter", "quarter", "quarter"],
  "tempo": 120,
  "channel": 1
}
```

#### 2. Formato H√≠brido Simples
```json
{
  "bpm": 120,
  "notes": "C4:q D4:q E4:q F4:q"
}
```

#### 3. Expressividade Completa
```json
{
  "bpm": 156,
  "notes": "A4:q@0.7.leg B4:e@0.8 A4:e@0.9.stac | G4:h@0.85 F#4:h@0.8",
  "reverb": 0.6,
  "swing": 0.1
}
```

#### 4. Casos Edge
- Notas com bem√≥is: `Bb4:q`
- Dura√ß√µes curtas: `C4:t`
- Velocity extremas: `@0.1`, `@1.0`
- Compassos vazios
- Articula√ß√µes m√∫ltiplas

## üöÄ Entrega Esperada

### Arquivos Principais
- [ ] `src/utils/hybrid-notation-parser.ts` - Parser completo
- [ ] `src/schemas/midi-schemas.ts` - Schemas atualizados
- [ ] `src/tools/midi-tools.ts` - Todas as ferramentas atualizadas
- [ ] `docs/HYBRID_NOTATION.md` - Documenta√ß√£o nova
- [ ] `docs/API.md` - Documenta√ß√£o atualizada
- [ ] Testes unit√°rios para parser e ferramentas

### Caracter√≠sticas da Implementa√ß√£o
- **Robusta**: Trata todos os casos edge
- **Performante**: R√°pida para arquivos grandes
- **Compat√≠vel**: C√≥digo antigo funciona sem mudan√ßas
- **Extens√≠vel**: F√°cil adicionar novos recursos futuros
- **Documentada**: Exemplos claros para desenvolvedores

### Valida√ß√£o Final
- [ ] Todos os exemplos da documenta√ß√£o funcionam
- [ ] Performance medida e adequada
- [ ] Casos de teste passam
- [ ] Code review completo
- [ ] Compatibilidade verificada com c√≥digo existente

---

**Resultado esperado**: Sistema de nota√ß√£o musical expressivo, intuitivo e profissional, mantendo total compatibilidade com implementa√ß√µes existentes.