# Prompt para Desenvolvimento do Servidor MCP Musical - M√≥dulo MIDI

## Objetivo Principal
Desenvolva um servidor MCP (Model Context Protocol) profissional para controle musical, come√ßando pelo **M√≥dulo MIDI**. Este servidor permitir√° que clientes MCP (como Claude Desktop) controlem instrumentos f√≠sicos e virtuais atrav√©s de comandos MIDI precisos, expressivos e musicalmente inteligentes.

## Vis√£o Geral da Arquitetura Completa
O sistema completo ter√° dois m√≥dulos principais:
1. **M√≥dulo MIDI** (implementar AGORA) - Tradu√ß√£o de comandos musicais em sinais MIDI com timing preciso
2. **M√≥dulo Audio Feedback** (implementar POSTERIORMENTE) - An√°lise em tempo real do √°udio para feedback inteligente e adapta√ß√£o

---

## Especifica√ß√µes Detalhadas do M√≥dulo MIDI

### Arquitetura de 3 Pilares (Pipeline de Processamento)

#### Pilar 1: O Tradutor (Intelig√™ncia Musical e Valida√ß√£o)

**Responsabilidades:**
- Valida√ß√£o rigorosa de schemas JSON de entrada
- Interpreta√ß√£o de comandos musicais abstratos
- Expans√£o de estruturas musicais complexas
- Normaliza√ß√£o de dados para execu√ß√£o

**Stack Tecnol√≥gico:**
- **Tonal.js**: Teoria musical, expans√£o de acordes, transposi√ß√£o, an√°lise harm√¥nica
- **Zod**: Valida√ß√£o de schemas e tipos TypeScript seguros

**Input Esperado (PlanoMusical):**
```typescript
interface PlanoMusical {
  bpm: number;
  timeSignature?: string; // "4/4", "3/4", etc.
  key?: string; // "C major", "Am", etc.
  events: MusicEvent[];
}

interface MusicEvent {
  time: string; // Nota√ß√£o musical: "0:0", "1:2:3", "4n", "8t"
  type: "note" | "chord" | "cc" | "sequence" | "rest";
  value: string | number | object;
  duration?: string; // "4n", "8n", "2n.", "16t"
  velocity?: number; // 0-1
  channel?: number; // 1-16
  articulation?: "legato" | "staccato" | "tenuto" | "marcato";
  [key: string]: any; // Propriedades espec√≠ficas por tipo
}
```

**Output Detalhado (PartituraExecut√°vel):**
```typescript
interface PartituraExecut√°vel {
  metadata: {
    bpm: number;
    timeSignature: string;
    key: string;
    totalDuration: string;
    eventCount: number;
  };
  
  noteEvents: NoteEvent[];
  controlChangeEvents: CCEvent[];
  systemEvents: SystemEvent[];
}

interface NoteEvent {
  absoluteTime: number; // Tempo absoluto em segundos
  toneName: string; // "C4", "F#3", etc.
  midiNote: number; // 0-127
  velocity: number; // 0-1 (normalizado)
  duration: number; // Dura√ß√£o em segundos
  channel: number; // 1-16
  articulation: ArticulationType;
  noteOffTime: number; // Tempo calculado para note-off
}

interface CCEvent {
  absoluteTime: number;
  controller: number; // 0-127
  value: number; // 0-127
  channel: number;
  description?: string; // "Volume", "Pan", "Reverb", etc.
}

interface SystemEvent {
  absoluteTime: number;
  type: "tempo_change" | "time_signature" | "program_change";
  value: any;
  channel?: number;
}
```

**Fun√ß√µes de Transforma√ß√£o Obrigat√≥rias:**
- `expandChord(chord: string, voicing?: string)`: Expandir acordes para notas individuais
- `parseMusicalTime(time: string, bpm: number)`: Converter nota√ß√£o musical em tempo absoluto
- `validateMusicTheory(data: any)`: Validar consist√™ncia musical
- `normalizeVelocity(velocity: any)`: Normalizar velocity para 0-1
- `calculateArticulation(type: string, duration: number)`: Aplicar articula√ß√£o

---

#### Pilar 2: O Maestro (Agendamento Temporal de Precis√£o)

**Responsabilidades:**
- Agendamento temporal de alta precis√£o
- Sincroniza√ß√£o de m√∫ltiplos eventos
- Controle de playback (play, pause, stop, loop)
- Gest√£o de tempo musical (BPM, time signature)

**Stack Tecnol√≥gico:**
- **Tone.js**: Framework de √°udio/musical com Tone.Transport para agendamento preciso

**Input:** PartituraExecut√°vel do Pilar 1

**Funcionalidades Principais:**
```typescript
interface MaestroEngine {
  // Controle de Transport
  play(): void;
  pause(): void;
  stop(): void;
  setBPM(bpm: number): void;
  
  // Agendamento
  schedulePartitura(partitura: PartituraExecut√°vel): string; // retorna playbackId
  scheduleEvent(event: ScheduledEvent, time: number): void;
  
  // Estado
  getCurrentTime(): number;
  getPlaybackState(): "playing" | "paused" | "stopped";
  
  // Callbacks para Pilar 3
  onNoteEvent: (event: NoteEvent) => void;
  onCCEvent: (event: CCEvent) => void;
  onSystemEvent: (event: SystemEvent) => void;
}
```

**Output:** Chamadas de fun√ß√£o temporalmente precisas para o Pilar 3

---

#### Pilar 3: O Mensageiro (Interface MIDI de Baixo N√≠vel)

**Responsabilidades:**
- Comunica√ß√£o direta com portas MIDI
- Gest√£o de conex√µes e dispositivos
- Tradu√ß√£o para protocolo MIDI
- Monitoramento de status das portas

**Stack Tecnol√≥gico:**
- **jzz** (preferencial) ou **node-midi**: Comunica√ß√£o MIDI multiplataforma

**API de Interface:**
```typescript
interface MensageiroMIDI {
  // Gest√£o de Portas
  listPorts(): MidiPort[];
  connectToPort(portName: string): boolean;
  disconnectPort(): void;
  getConnectedPort(): string | null;
  
  // Envio Imediato
  sendNoteOn(note: number, velocity: number, channel: number): void;
  sendNoteOff(note: number, channel: number): void;
  sendCC(controller: number, value: number, channel: number): void;
  sendProgramChange(program: number, channel: number): void;
  
  // Utilidades
  sendAllNotesOff(channel?: number): void;
  sendPanic(): void; // Emergency stop
}

interface MidiPort {
  id: string;
  name: string;
  type: "input" | "output";
  connected: boolean;
  manufacturer?: string;
}
```

---

## Ferramentas MCP Obrigat√≥rias

### 1. Gest√£o de Sistema
```typescript
// Listar portas MIDI dispon√≠veis
"midi_list_ports": {
  description: "üéπ Lista todas as portas MIDI dispon√≠veis (entrada e sa√≠da) no sistema",
  parameters: {
    refresh?: boolean; // For√ßar refresh da lista
  }
}

// Configurar porta de sa√≠da padr√£o
"configure_midi_output": {
  description: "üîß Configura a porta MIDI de sa√≠da padr√£o para todas as opera√ß√µes",
  parameters: {
    portName: string; // Nome exato da porta
  }
}
```

### 2. Controle Musical B√°sico
```typescript
// Enviar nota individual
"midi_send_note": {
  description: "üéµ Envia uma nota MIDI individual com controle completo de par√¢metros",
  parameters: {
    note: string | number; // "C4" ou 60
    velocity?: number; // 0-1 (padr√£o: 0.8)
    duration?: number; // Em segundos (padr√£o: 1.0)
    channel?: number; // 1-16 (padr√£o: 1)
    outputPort?: string; // Override da porta padr√£o
  }
}

// Tocar frase musical com articula√ß√£o
"midi_play_phrase": {
  description: "üéº Toca uma frase musical com articula√ß√£o e express√£o natural",
  parameters: {
    notes: string; // "C4 E4 G4 C5" (separado por espa√ßo)
    rhythm?: string; // "quarter quarter half whole" ou valor √∫nico
    tempo?: number; // BPM (padr√£o: 120)
    style?: "legato" | "staccato" | "tenuto" | "marcato"; // (padr√£o: "legato")
    channel?: number;
    outputPort?: string;
  }
}
```

### 3. Controle Avan√ßado
```typescript
// Executar sequ√™ncia de comandos MIDI
"midi_sequence_commands": {
  description: "üé≠ Executa uma sequ√™ncia complexa de comandos MIDI com timing preciso",
  parameters: {
    commands: Array<{
      type: "note" | "cc" | "delay";
      time?: number; // Offset em segundos
      // Par√¢metros espec√≠ficos por tipo
      note?: string;
      duration?: number;
      velocity?: number;
      controller?: number;
      value?: number;
      channel?: number;
    }>;
    outputPort?: string;
  }
}

// Enviar Control Change
"midi_send_cc": {
  description: "üéõÔ∏è Envia mensagem MIDI Control Change para modificar par√¢metros do instrumento",
  parameters: {
    controller: number | string; // 7 (Volume) ou "volume"
    value: number; // 0-127
    channel?: number; // 1-16 (padr√£o: 1)
    outputPort?: string;
  }
}
```

### 4. Gest√£o de Tempo e Estado
```typescript
// Definir BPM global
"midi_set_tempo": {
  description: "‚è±Ô∏è Define o BPM (Beats Per Minute) global para todas as opera√ß√µes musicais",
  parameters: {
    bpm: number; // 60-200
  }
}

// Controle de playback
"midi_transport_control": {
  description: "‚ñ∂Ô∏è Controla o transport musical (play, pause, stop) do sistema",
  parameters: {
    action: "play" | "pause" | "stop" | "rewind";
  }
}

// Emerg√™ncia - parar tudo
"midi_panic": {
  description: "üö® Para imediatamente toda a reprodu√ß√£o MIDI (All Notes Off + Reset Controllers)",
  parameters: {} // Sem par√¢metros - a√ß√£o imediata
}
```

---

## Recursos T√©cnicos Obrigat√≥rios

### Schemas Zod Rigorosos
**OBRIGAT√ìRIO**: Use `/context7` para consultar melhores pr√°ticas:
- Valida√ß√£o completa de todos os inputs
- Mensagens de erro claras e musicalmente contextualizadas
- Transforma√ß√£o autom√°tica de tipos
- Valida√ß√£o de teoria musical (notas v√°lidas, ranges MIDI, etc.)

### MCP Inspector
- Configure desde o primeiro commit
- Documente como testar cada ferramenta isoladamente
- Inclua exemplos de uso para cada fun√ß√£o
- Crie cen√°rios de teste musicais

### Tratamento de Lat√™ncia
- Target: < 15ms glass-to-glass
- Use Tone.Transport como rel√≥gio mestre
- Implemente buffer de √°udio adequado
- Monitore performance em tempo real

---

## Instru√ß√µes de Desenvolvimento

### 1. Setup Inicial
```bash
# Estrutura de projeto obrigat√≥ria
maestro-mcp/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ pilares/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tradutor/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ music-theory.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validators.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transformers.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ maestro/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scheduler.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transport.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ event-manager.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mensageiro/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ midi-interface.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ port-manager.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ protocol.ts
‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ midi-schemas.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ music-schemas.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ common-schemas.ts
‚îÇ   ‚îú‚îÄ‚îÄ tools/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ midi-tools.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ system-tools.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ music-theory.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ timing.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.ts
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îî‚îÄ‚îÄ server.ts
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îî‚îÄ‚îÄ musical/
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ API.md
‚îÇ   ‚îú‚îÄ‚îÄ SETUP.md
‚îÇ   ‚îî‚îÄ‚îÄ MUSICAL_EXAMPLES.md
‚îú‚îÄ‚îÄ mcp-inspector/
‚îÇ   ‚îî‚îÄ‚îÄ config.json
‚îî‚îÄ‚îÄ examples/
    ‚îú‚îÄ‚îÄ basic-usage.js
    ‚îú‚îÄ‚îÄ complex-sequences.js
    ‚îî‚îÄ‚îÄ daw-integration.js
```

### 2. Consulta Context7 OBRIGAT√ìRIA
**PRIMEIRO PASSO**: Use `/context7` para consultar:
- `/context7/zod` - Melhores pr√°ticas para schemas Zod em servidores MCP
- `/context7/mcp` - Padr√µes de nomenclatura e estrutura para ferramentas MCP
- `/context7/typescript` - Configura√ß√£o TypeScript para projetos MCP
- `/context7/testing` - Estrat√©gias de teste para servidores MCP

### 3. Ordem de Implementa√ß√£o
1. **Setup b√°sico + Context7**: Configura√ß√£o inicial e consulta √†s melhores pr√°ticas
2. **Schemas Zod**: Defini√ß√£o completa de tipos e valida√ß√µes
3. **Pilar 3 (Mensageiro)**: Interface MIDI b√°sica (mais simples, test√°vel isoladamente)
4. **Pilar 1 (Tradutor)**: L√≥gica musical e transforma√ß√µes
5. **Pilar 2 (Maestro)**: Agendamento temporal (mais complexo)
6. **Ferramentas MCP**: Implementa√ß√£o das 8 ferramentas obrigat√≥rias
7. **MCP Inspector**: Configura√ß√£o e documenta√ß√£o de testes
8. **Testes e valida√ß√£o**: Cen√°rios musicais reais

---

## Crit√©rios de Sucesso

### Funcionais ‚úÖ
- [ ] **Todas as 8 ferramentas MCP funcionando perfeitamente**
- [ ] **Conex√£o est√°vel com DAWs** (GarageBand, Logic Pro, Ableton)
- [ ] **Execu√ß√£o precisa de sequ√™ncias musicais complexas** (tercinas, s√≠ncopas, polirritmia)
- [ ] **Suporte completo para teoria musical** (acordes, escalas, modula√ß√µes)
- [ ] **Lat√™ncia inferior a 15ms** (verific√°vel com ferramentas de medi√ß√£o)
- [ ] **Gest√£o robusta de erros** (reconex√£o autom√°tica, recovery graceful)

### T√©cnicos ‚úÖ
- [ ] **MCP Inspector 100% configurado** com exemplos para cada ferramenta
- [ ] **Schemas Zod validando todos os inputs** com mensagens de erro claras
- [ ] **Arquitetura de 3 pilares implementada** com baixo acoplamento
- [ ] **Gest√£o completa de portas MIDI** (listagem, conex√£o, monitoramento)
- [ ] **Sistema de logging estruturado** para debug e monitoramento
- [ ] **Documenta√ß√£o t√©cnica completa** (API, setup, troubleshooting)

### Qualidade ‚úÖ
- [ ] **C√≥digo TypeScript 100% tipado** com strict mode
- [ ] **Cobertura de testes > 80%** (unit + integration + musical)
- [ ] **Performance otimizada** (profiling de lat√™ncia, memory leaks)
- [ ] **Documenta√ß√£o musical** com exemplos pr√°ticos e casos de uso
- [ ] **Compatibilidade multiplataforma** (macOS, Windows, Linux)

---

## Casos de Teste Musicais Obrigat√≥rios

### Teste B√°sico
```javascript
// Deve tocar uma escala de D√≥ maior
await mcp.midi_play_phrase({
  notes: "C4 D4 E4 F4 G4 A4 B4 C5",
  rhythm: "eighth",
  tempo: 120
});
```

### Teste Harm√¥nico
```javascript
// Deve expandir e tocar progress√£o ii-V-I
await mcp.midi_sequence_commands({
  commands: [
    { type: "chord", value: "Dm7", time: 0 },
    { type: "chord", value: "G7", time: 1 },
    { type: "chord", value: "Cmaj7", time: 2 }
  ]
});
```

### Teste de Lat√™ncia
```javascript
// Deve manter sincroniza√ß√£o perfeita em BPM alto
await mcp.midi_set_tempo({ bpm: 160 });
await mcp.midi_play_phrase({
  notes: "C4 C4 C4 C4",
  rhythm: "sixteenth"
});
```

---

## Pr√≥ximos Passos (Roadmap)

Ap√≥s conclus√£o e valida√ß√£o completa do **M√≥dulo MIDI**, ser√° fornecido prompt espec√≠fico para implementa√ß√£o do **M√≥dulo Audio Feedback** incluindo:
- An√°lise em tempo real com Essentia.js
- Captura de √°udio com BlackHole (macOS)
- WebSocket para streaming de dados
- IA musical para feedback adaptativo

**IMPORTANTE:**
- use o esquema/ fluxo multiagente para desenvolver o projeto, respeitando as etapas principalmente do auditor.
---

**üöÄ COMECE AGORA:**
1. Consulte `/context7` para estabelecer melhores pr√°ticas
2. Configure o setup b√°sico do projeto
3. Implemente Pilar 3 (Mensageiro) primeiro para testes isolados
4. Continue sequencialmente conforme ordem especificada
